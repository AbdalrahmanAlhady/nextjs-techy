# Story 4.6: As a Buyer, I can leave a rating and review

## Status: Draft

## Story

- As a Buyer
- I want to leave a rating and review for a product I purchased
- so that I can share my feedback with the vendor and other potential buyers.

## Acceptance Criteria (ACs)

- [ ] On the detailed product page, there is a section for writing a review.
- [ ] Only users who have purchased the product are able to leave a review.
- [ ] The review form includes a star rating (1-5) and a text area for comments.
- [ ] Submitting the form saves the rating and review to the database, associated with the product and the user.
- [ ] The product's average rating is updated and displayed on the product detail and listing pages.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1, 2, 3): Create the review submission form UI.
  - [ ] Subtask 1.1: Implement logic to check if the current user has purchased the product.
  - [ ] Subtask 1.2: Build the star rating input component.
- [ ] Task 2 (AC: 4): Implement the server action to save the review.
  - [ ] Subtask 2.1: Add the review to a `reviews` table in the database.
- [ ] Task 3 (AC: 5): Implement the logic to calculate and display the average rating.
  - [ ] Subtask 3.1: This could be a database trigger or a calculation performed when fetching product data.

## Dev Notes

- The check to see if a user has purchased a product is critical to ensure review authenticity. This will involve querying the `orders` and `order_items` tables.
- The `reviews` table should include `productId`, `userId`, `rating`, `comment`, and a timestamp.

### Testing

Dev Note: Story Requires the following tests:

- [ ] Jest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Cypress E2E: location: `/e2e/epic-4/product-review.test.ts`

Manual Test Steps:

- Purchase a product.
- Navigate to that product's detail page.
- Write and submit a review.
- Verify your review is now visible on the page.
- Check if the product's average rating has been updated on both the detail and listing pages.

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### File List

[[LLM: (Dev Agent) List every new file created, or existing file modified in a bullet list.]]

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |

## QA Results

[[LLM: QA Agent Results]]
